<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Jogador - Renascer Union</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .player-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .player-details h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .player-details p {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .participate-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            margin-right: 15px;
        }
        
        .participate-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .participate-btn.participating {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .participate-btn.participating:hover {
            background: linear-gradient(135deg, #F57C00 0%, #FF9800 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .dashboard-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-button {
            background: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
        }
        
        /* Estilos para o ranking de jogadores por item */
        .player-positions-alert {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .player-positions-alert h4 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .positions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .position-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .rankings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .item-ranking {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .item-title {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ranking-player {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .ranking-player:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .ranking-player.logged-player {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border: 2px solid #fdcb6e;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(253, 203, 110, 0.3);
        }
        
        .ranking-player.logged-player:hover {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        }
        
        .ranking-player.inactive {
            opacity: 0.6;
        }
        
        .ranking-player .position {
            font-weight: bold;
            font-size: 16px;
            min-width: 40px;
        }
        
        .ranking-player .player-name {
            flex: 1;
            margin: 0 15px;
            font-weight: 500;
        }
        
        .ranking-player .player-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .show-more-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 15px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .show-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-button {
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .nav-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .nav-button:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .item-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .date-badge {
            background: #e9ecef;
            color: #666;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .history-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-item-player {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }
        
        .history-item-date {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 10px;
            border-radius: 15px;
        }
        
        .history-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-item-icon {
            font-size: 24px;
        }
        
        .history-item-details {
            flex: 1;
        }
        
        .history-item-item {
            font-weight: 500;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .history-item-description {
            font-size: 14px;
            color: #666;
        }

        /* Modal de Seleção de Itens */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .item-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .item-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .item-card.selected {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        }
        
        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .item-name {
            font-weight: 600;
            color: #333;
        }
        
        .item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selected-count {
            color: #666;
            font-weight: 500;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            .player-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .dashboard-nav {
                justify-content: center;
            }
            
            .nav-button {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
            
            .history-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-header">
            <div class="player-info">
                <div class="player-avatar">🎮</div>
                <div class="player-details">
                    <h2 id="player-name">Carregando...</h2>
                    <p>Dashboard do Jogador</p>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                <button id="participate-btn" class="participate-btn" onclick="toggleParticipation()">
                    🎯 Participar
                </button>
                <button class="logout-btn" onclick="logout()">
                    🚪 Sair
                </button>
            </div>
        </div>
        
        <div class="dashboard-nav">
            <button class="nav-button active" onclick="showSection('overview')">
                📊 Visão Geral
            </button>
            <button class="nav-button" onclick="showSection('history-general')">
                📋 Histórico Geral
            </button>
            <button class="nav-button" onclick="showSection('history-personal')">
                👤 Meu Histórico
            </button>
        </div>

        <!-- Seção Visão Geral -->
        <div id="overview-section" class="content-section active">
            <h2 class="section-title">
                📊 Visão Geral
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="my-items-count">0</div>
                    <div class="stat-label">Meus Itens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-players">0</div>
                    <div class="stat-label">Total de Jogadores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-items">0</div>
                    <div class="stat-label">Total de Itens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="last-item-date">-</div>
                    <div class="stat-label">Último Item</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>🎯 Meus Últimos Itens</h3>
                <button class="refresh-btn" onclick="loadOverviewData()">
                    🔄 Atualizar
                </button>
            </div>
            
            <div id="recent-items">
                <div class="empty-state">
                    <div class="empty-state-icon">📦</div>
                    <p>Carregando seus itens...</p>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 40px 0 20px 0;">
                <h3>🏆 Ranking de Jogadores</h3>
                <button class="refresh-btn" onclick="loadPlayersRanking()">
                    🔄 Atualizar
                </button>
            </div>
            
            <div id="players-ranking">
                <div class="empty-state">
                    <div class="empty-state-icon">🏆</div>
                    <p>Carregando ranking...</p>
                </div>
            </div>
        </div>

        <!-- Seção Histórico Geral -->
        <div id="history-general-section" class="content-section">
            <h2 class="section-title">
                📋 Histórico Geral de Itens
            </h2>
            
            <div class="history-filters">
                <div class="filter-group">
                    <label>Jogador</label>
                    <select id="filter-player-general">
                        <option value="">Todos os jogadores</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Item</label>
                    <input type="text" id="filter-item-general" placeholder="Nome do item">
                </div>
                <div class="filter-group">
                    <label>Data</label>
                    <input type="date" id="filter-date-general">
                </div>
                <button class="refresh-btn" onclick="loadGeneralHistory()">
                    🔍 Filtrar
                </button>
            </div>
            
            <div id="general-history-content">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <p>Carregando histórico geral...</p>
                </div>
            </div>
        </div>

        <!-- Seção Histórico Pessoal -->
        <div id="history-personal-section" class="content-section">
            <h2 class="section-title">
                👤 Meu Histórico Pessoal
            </h2>
            
            <div class="history-filters">
                <div class="filter-group">
                    <label>Item</label>
                    <input type="text" id="filter-item-personal" placeholder="Nome do item">
                </div>
                <div class="filter-group">
                    <label>Data</label>
                    <input type="date" id="filter-date-personal">
                </div>
                <button class="refresh-btn" onclick="loadPersonalHistory()">
                    🔍 Filtrar
                </button>
            </div>
            
            <div id="personal-history-content">
                <div class="empty-state">
                    <div class="empty-state-icon">👤</div>
                    <p>Carregando seu histórico...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Itens -->
    <div id="items-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🎯 Selecionar Itens para Participar</h3>
                <button class="modal-close" onclick="closeItemsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selecione os itens que você gostaria de receber:</p>
                <div id="items-grid" class="items-grid">
                    <!-- Itens serão carregados dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="selected-count" id="selected-count">0 itens selecionados</div>
                <button class="confirm-btn" id="confirm-selection" onclick="confirmItemSelection()" disabled>
                    ✅ Confirmar Seleção
                </button>
            </div>
        </div>
    </div>

    <script>
        // Verificar autenticação
        if (localStorage.getItem('userType') !== 'player' || localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
        
        // Obter nick do jogador
        const playerNick = localStorage.getItem('playerNick');
        document.getElementById('player-name').textContent = playerNick || 'Jogador';

        // Função para logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Função para mostrar seção
        function showSection(sectionName) {
            // Remover classe active de todos os botões
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            
            // Remover classe active de todas as seções
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            
            // Adicionar classe active ao botão clicado
            event.target.classList.add('active');
            
            // Mostrar seção correspondente
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Carregar dados da seção
            switch(sectionName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'history-general':
                    loadGeneralHistory();
                    break;
                case 'history-personal':
                    loadPersonalHistory();
                    break;
            }
        }

        // Função para carregar dados da visão geral
        async function loadOverviewData() {
            try {
                // Carregar histórico pessoal para contar itens
                const historyResponse = await fetch('/.netlify/functions/supabase-api/history');
                const historyData = await historyResponse.json();
                
                const myItems = historyData.history?.filter(entry => 
                    entry.player?.toLowerCase() === playerNick.toLowerCase()
                ) || [];
                
                document.getElementById('my-items-count').textContent = myItems.length;
                
                // Carregar total de jogadores
                const playersResponse = await fetch('/.netlify/functions/supabase-api/players');
                const playersData = await playersResponse.json();
                document.getElementById('total-players').textContent = playersData.players?.length || 0;
                
                // Carregar total de itens
                const itemsResponse = await fetch('/.netlify/functions/supabase-api/items');
                const itemsData = await itemsResponse.json();
                document.getElementById('total-items').textContent = itemsData.items?.length || 0;
                
                // Último item
                if (myItems.length > 0) {
                    const lastItem = myItems[myItems.length - 1];
                    const lastDate = new Date(lastItem.date).toLocaleDateString('pt-BR');
                    document.getElementById('last-item-date').textContent = lastDate;
                } else {
                    document.getElementById('last-item-date').textContent = 'Nenhum';
                }
                
                // Mostrar últimos itens
                const recentItemsContainer = document.getElementById('recent-items');
                if (myItems.length > 0) {
                    const recentItems = myItems.slice(-5).reverse();
                    recentItemsContainer.innerHTML = `
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentItems.map(item => `
                                    <tr>
                                        <td><span class="item-badge">${item.item}</span></td>
                                        <td><span class="date-badge">${new Date(item.date).toLocaleDateString('pt-BR')}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    recentItemsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <p>Você ainda não recebeu nenhum item</p>
                        </div>
                    `;
                }
                
                // Carregar ranking de jogadores
                loadPlayersRanking();
                
            } catch (error) {
                console.error('Erro ao carregar dados da visão geral:', error);
            }
        }

        // Estado para controlar expansão dos rankings (global para todos os itens)
        let allRankingsExpanded = false;
        
        // Função para carregar ranking de jogadores por item
        async function loadPlayersRanking() {
            try {
                const playersResponse = await fetch('/.netlify/functions/supabase-api/players');
                const playersData = await playersResponse.json();
                const itemsResponse = await fetch('/.netlify/functions/supabase-api/items');
                const itemsData = await itemsResponse.json();
                
                const players = playersData.players || [];
                const items = itemsData.items || [];
                
                // Criar ranking para cada item
                const itemRankings = items.map(item => {
                    const itemName = typeof item === 'string' ? item : item.name || item;
                    const playersWithItem = players
                        .map(player => ({
                            name: player.name,
                            count: player.counts[itemName] || 0,
                            active: player.status === 'active'
                        }))
                        .sort((a, b) => a.count - b.count); // Ordena por quantidade crescente (menor no topo)
                    
                    return {
                        item: itemName,
                        players: playersWithItem
                    };
                });
                
                // Encontrar posição do jogador logado em cada item
                const playerPositions = {};
                itemRankings.forEach(ranking => {
                    const playerIndex = ranking.players.findIndex(p => 
                        p.name.toLowerCase() === playerNick.toLowerCase()
                    );
                    if (playerIndex !== -1) {
                        playerPositions[ranking.item] = playerIndex + 1;
                    }
                });
                
                const container = document.getElementById('players-ranking');
                
                // Mostrar aviso de posições do jogador
                const positionsHtml = Object.keys(playerPositions).length > 0 ? `
                    <div class="player-positions-alert">
                        <h4>🎯 Suas Posições:</h4>
                        <div class="positions-grid">
                            ${Object.entries(playerPositions).map(([item, position]) => {
                                const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `#${position}`;
                                return `<span class="position-badge">${item}: ${medal}</span>`;
                            }).join('')}
                        </div>
                    </div>
                ` : '';
                
                const html = itemRankings.map((ranking, itemIndex) => {
                    const displayLimit = allRankingsExpanded ? ranking.players.length : 8;
                    const displayPlayers = ranking.players.slice(0, displayLimit);
                    const hasMorePlayers = ranking.players.length > 8;
                    
                    const playersHtml = displayPlayers.map((player, index) => {
                        const position = index + 1;
                        const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `${position}º`;
                        const activeClass = player.status === 'active' ? 'active' : 'inactive';
                        const isLoggedPlayer = player.name.toLowerCase() === playerNick.toLowerCase();
                        const highlightClass = isLoggedPlayer ? 'logged-player' : '';
                        
                        return `
                            <div class="ranking-player ${activeClass} ${highlightClass}">
                                <span class="position">${medal}</span>
                                <span class="player-name">${player.name}${isLoggedPlayer ? ' (Você)' : ''}</span>
                                <span class="player-count">${player.count}</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Mostrar botão apenas no primeiro item se algum item tiver mais de 8 jogadores
                    const anyItemHasMore = itemRankings.some(r => r.players.length > 8);
                    const showMoreButton = (itemIndex === 0 && anyItemHasMore) ? `
                        <button class="show-more-btn" onclick="toggleAllRankingsExpansion()">
                            ${allRankingsExpanded ? '📤 Mostrar Menos (Todos os Itens)' : '📥 Mostrar Mais (Todos os Itens)'}
                        </button>
                    ` : '';
                    
                    return `
                        <div class="item-ranking">
                            <h4 class="item-title">${ranking.item}</h4>
                            <div class="ranking-list">
                                ${playersHtml}
                            </div>
                            ${showMoreButton}
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = positionsHtml + `<div class="rankings-container">${html}</div>`;
                
            } catch (error) {
                console.error('Erro ao carregar ranking de jogadores:', error);
                const container = document.getElementById('players-ranking');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <p>Erro ao carregar ranking</p>
                    </div>
                `;
            }
        }
        
        // Função para alternar expansão do ranking
        function toggleAllRankingsExpansion() {
            allRankingsExpanded = !allRankingsExpanded;
            loadPlayersRanking();
        }

        // Função para carregar histórico geral
        async function loadGeneralHistory() {
            try {
                const response = await fetch('/.netlify/functions/supabase-api/history');
                const data = await response.json();
                
                let history = data.history || [];
                
                // Aplicar filtros
                const playerFilter = document.getElementById('filter-player-general').value;
                const itemFilter = document.getElementById('filter-item-general').value.toLowerCase();
                const dateFilter = document.getElementById('filter-date-general').value;
                
                if (playerFilter) {
                    history = history.filter(entry => entry.player === playerFilter);
                }
                
                if (itemFilter) {
                    history = history.filter(entry => 
                        entry.item.toLowerCase().includes(itemFilter)
                    );
                }
                
                if (dateFilter) {
                    history = history.filter(entry => {
                        const entryDate = new Date(entry.date).toISOString().split('T')[0];
                        return entryDate === dateFilter;
                    });
                }
                
                // Carregar lista de jogadores para o filtro
                const playersResponse = await fetch('/.netlify/functions/supabase-api/players');
                const playersData = await playersResponse.json();
                const playerSelect = document.getElementById('filter-player-general');
                playerSelect.innerHTML = '<option value="">Todos os jogadores</option>';
                playersData.players?.forEach(player => {
                    playerSelect.innerHTML += `<option value="${player.name}">${player.name}</option>`;
                });
                
                // Mostrar histórico
                const container = document.getElementById('general-history-content');
                if (history.length > 0) {
                    container.innerHTML = `
                        <div class="history-list">
                            ${history.map(entry => `
                                <div class="history-item">
                                    <div class="history-item-header">
                                        <div class="history-item-player">👤 ${entry.player}</div>
                                        <div class="history-item-date">${new Date(entry.date).toLocaleDateString('pt-BR')}</div>
                                    </div>
                                    <div class="history-item-content">
                                        <div class="history-item-icon">📦</div>
                                        <div class="history-item-details">
                                            <div class="history-item-item">${entry.item}</div>
                                            <div class="history-item-description">Item recebido pelo jogador</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>Nenhum registro encontrado</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao carregar histórico geral:', error);
            }
        }

        // Função para carregar histórico pessoal
        async function loadPersonalHistory() {
            try {
                const response = await fetch('/.netlify/functions/supabase-api/history');
                const data = await response.json();
                
                let history = data.history?.filter(entry => 
                    entry.player?.toLowerCase() === playerNick.toLowerCase()
                ) || [];
                
                // Aplicar filtros
                const itemFilter = document.getElementById('filter-item-personal').value.toLowerCase();
                const dateFilter = document.getElementById('filter-date-personal').value;
                
                if (itemFilter) {
                    history = history.filter(entry => 
                        entry.item.toLowerCase().includes(itemFilter)
                    );
                }
                
                if (dateFilter) {
                    history = history.filter(entry => {
                        const entryDate = new Date(entry.date).toISOString().split('T')[0];
                        return entryDate === dateFilter;
                    });
                }
                
                // Mostrar histórico
                const container = document.getElementById('personal-history-content');
                if (history.length > 0) {
                    container.innerHTML = `
                        <div class="history-list">
                            ${history.map(entry => `
                                <div class="history-item">
                                    <div class="history-item-header">
                                        <div class="history-item-player">🎯 Meu Item</div>
                                        <div class="history-item-date">${new Date(entry.date).toLocaleDateString('pt-BR')}</div>
                                    </div>
                                    <div class="history-item-content">
                                        <div class="history-item-icon">📦</div>
                                        <div class="history-item-details">
                                            <div class="history-item-item">${entry.item}</div>
                                            <div class="history-item-description">Item recebido por você</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">👤</div>
                            <p>Você ainda não possui histórico de itens</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao carregar histórico pessoal:', error);
            }
        }

        // Variáveis globais para participação
        let isParticipating = false;
        let selectedItems = new Set();
        let availableItems = [];

        // Função para alternar participação
        async function toggleParticipation() {
            const participateBtn = document.getElementById('participate-btn');
            
            if (!isParticipating) {
                // Ativar participação - apenas marcar na tabela admin e mostrar botão escolher itens
                try {
                    participateBtn.disabled = true;
                    participateBtn.innerHTML = '⏳ Marcando...';
                    
                    // Marcar o jogador na tabela de distribuição do admin
                    await markPlayerInAdminTable(true);
                    
                    // Atualizar status do jogador
                    await updatePlayerStatus(true);
                    
                    // Mostrar botão "escolher itens" ao lado do botão participar
                    showChooseItemsButton();
                    
                } catch (error) {
                    console.error('Erro ao marcar participação:', error);
                    alert('Erro ao marcar participação. Tente novamente.');
                } finally {
                    participateBtn.disabled = false;
                }
            } else {
                // Desativar participação
                if (confirm('Tem certeza que deseja parar de participar?')) {
                    await updatePlayerStatus(false);
                    await markPlayerInAdminTable(false);
                    hideChooseItemsButton();
                }
            }
        }

        // Função para carregar itens ativos
        async function loadActiveItems() {
            const response = await fetch('/.netlify/functions/supabase-api/items/active');
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Erro ao carregar itens');
            }
            
            availableItems = data.items || [];
        }

        // Função para abrir modal de itens
        function openItemsModal() {
            const modal = document.getElementById('items-modal');
            const itemsGrid = document.getElementById('items-grid');
            
            // Limpar seleções anteriores
            selectedItems.clear();
            
            // Renderizar itens
            if (availableItems.length === 0) {
                itemsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📦</div>
                        <p>Nenhum item ativo disponível no momento.</p>
                    </div>
                `;
            } else {
                itemsGrid.innerHTML = availableItems.map(item => `
                    <div class="item-card" onclick="toggleItemSelection('${item.name}')" id="item-${item.name}">
                        <div class="item-card-header">
                            <div class="item-name">${item.name}</div>
                            <input type="checkbox" class="item-checkbox" id="checkbox-${item.name}" onchange="toggleItemSelection('${item.name}')">
                        </div>
                    </div>
                `).join('');
            }
            
            updateSelectedCount();
            modal.style.display = 'block';
        }

        // Função para fechar modal
        function closeItemsModal() {
            const modal = document.getElementById('items-modal');
            modal.style.display = 'none';
            selectedItems.clear();
        }

        // Função para alternar seleção de item
        function toggleItemSelection(itemName) {
            const itemCard = document.getElementById(`item-${itemName}`);
            const checkbox = document.getElementById(`checkbox-${itemName}`);
            
            if (selectedItems.has(itemName)) {
                selectedItems.delete(itemName);
                itemCard.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedItems.add(itemName);
                itemCard.classList.add('selected');
                checkbox.checked = true;
            }
            
            updateSelectedCount();
        }

        // Função para atualizar contador de selecionados
        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            const confirmBtn = document.getElementById('confirm-selection');
            const count = selectedItems.size;
            
            countElement.textContent = `${count} ${count === 1 ? 'item selecionado' : 'itens selecionados'}`;
            confirmBtn.disabled = count === 0;
        }

        // Função para confirmar seleção de itens
        async function confirmItemSelection() {
            if (selectedItems.size === 0) {
                alert('Selecione pelo menos um item para participar.');
                return;
            }
            
            try {
                const confirmBtn = document.getElementById('confirm-selection');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '⏳ Confirmando...';
                
                // Ativar status do jogador
                await updatePlayerStatus(true);
                
                // Fechar modal
                closeItemsModal();
                
                // Mostrar mensagem de sucesso
                alert(`Participação ativada! Você está concorrendo a ${selectedItems.size} ${selectedItems.size === 1 ? 'item' : 'itens'}.`);
                
            } catch (error) {
                console.error('Erro ao confirmar participação:', error);
                alert('Erro ao confirmar participação. Tente novamente.');
            } finally {
                const confirmBtn = document.getElementById('confirm-selection');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '✅ Confirmar Seleção';
            }
        }

        // Função para marcar jogador na tabela de distribuição do admin
        async function markPlayerInAdminTable(active) {
            try {
                // Simular marcação na tabela do admin através de localStorage
                // para sincronizar com a interface do admin
                const adminTableState = JSON.parse(localStorage.getItem('adminTableState') || '{}');
                
                if (!adminTableState.selectedPlayers) {
                    adminTableState.selectedPlayers = [];
                }
                
                if (active) {
                    // Adicionar jogador à lista de selecionados se não estiver
                    if (!adminTableState.selectedPlayers.includes(playerNick)) {
                        adminTableState.selectedPlayers.push(playerNick);
                    }
                } else {
                    // Remover jogador da lista de selecionados
                    adminTableState.selectedPlayers = adminTableState.selectedPlayers.filter(name => name !== playerNick);
                }
                
                localStorage.setItem('adminTableState', JSON.stringify(adminTableState));
                
                // Também atualizar o estado local do app.js para sincronizar o checkbox
                try {
                    const appState = JSON.parse(localStorage.getItem('guildDistributionState') || '{}');
                    if (appState.players) {
                        const player = appState.players.find(p => p.name === playerNick);
                        if (player) {
                            player.active = active;
                            localStorage.setItem('guildDistributionState', JSON.stringify(appState));
                        }
                    }
                } catch (stateError) {
                    console.log('Estado do app não encontrado, continuando...');
                }
                
                // Disparar evento para notificar outras abas/janelas
                window.dispatchEvent(new CustomEvent('playerSelectionChanged', {
                    detail: { playerName: playerNick, selected: active }
                }));
                
                // Disparar evento adicional para forçar atualização da tabela
                window.dispatchEvent(new CustomEvent('storage', {
                    detail: { key: 'adminTableState' }
                }));
                
            } catch (error) {
                console.error('Erro ao marcar jogador na tabela do admin:', error);
            }
        }

        // Função para atualizar status do jogador
        async function updatePlayerStatus(active) {
            const response = await fetch('/.netlify/functions/supabase-api/players/status', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    playerName: playerNick,
                    active: active
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Erro ao atualizar status');
            }
            
            isParticipating = active;
            updateParticipateButton();
        }

        // Função para atualizar botão de participação
        function updateParticipateButton() {
            const participateBtn = document.getElementById('participate-btn');
            
            if (isParticipating) {
                participateBtn.innerHTML = '✅ Marcado';
                participateBtn.classList.add('participating');
                showChooseItemsButton();
            } else {
                participateBtn.innerHTML = '🎯 Participar';
                participateBtn.classList.remove('participating');
                hideChooseItemsButton();
            }
        }
        
        // Função para mostrar botão "escolher itens"
        function showChooseItemsButton() {
            let chooseBtn = document.getElementById('choose-items-btn');
            if (!chooseBtn) {
                chooseBtn = document.createElement('button');
                chooseBtn.id = 'choose-items-btn';
                chooseBtn.className = 'participate-btn';
                chooseBtn.style.marginLeft = '10px';
                chooseBtn.innerHTML = '📦 Escolher Itens';
                chooseBtn.onclick = openChooseItemsFlow;
                
                const participateBtn = document.getElementById('participate-btn');
                participateBtn.parentNode.insertBefore(chooseBtn, participateBtn.nextSibling);
            }
            chooseBtn.style.display = 'inline-block';
        }
        
        // Função para esconder botão "escolher itens"
        function hideChooseItemsButton() {
            const chooseBtn = document.getElementById('choose-items-btn');
            if (chooseBtn) {
                chooseBtn.style.display = 'none';
            }
        }
        
        // Função para abrir fluxo de escolha de itens
        async function openChooseItemsFlow() {
            try {
                const chooseBtn = document.getElementById('choose-items-btn');
                chooseBtn.disabled = true;
                chooseBtn.innerHTML = '⏳ Carregando...';
                
                await loadActiveItems();
                openItemsModal();
                
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                alert('Erro ao carregar itens disponíveis. Tente novamente.');
            } finally {
                const chooseBtn = document.getElementById('choose-items-btn');
                chooseBtn.disabled = false;
                chooseBtn.innerHTML = '📦 Escolher Itens';
            }
        }

        // Função para verificar status inicial do jogador
        async function checkPlayerStatus() {
            try {
                const response = await fetch(`/.netlify/functions/supabase-api/players?name=${encodeURIComponent(playerNick)}`);
                const data = await response.json();
                
                if (data.players && data.players.length > 0) {
                    const player = data.players[0];
                    isParticipating = player.status === 'active';
                    updateParticipateButton();
                }
            } catch (error) {
                console.error('Erro ao verificar status do jogador:', error);
            }
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('items-modal');
            if (event.target === modal) {
                closeItemsModal();
            }
        }

        // Carregar dados iniciais
        loadOverviewData();
    </script>
</body>
</html>